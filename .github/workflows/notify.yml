name: Star and Fork Notifier

# 1. è§¦å‘æ¡ä»¶ï¼šå½“æœ‰äººç‚¹èµ (star) æˆ–æ´¾ç”Ÿ (fork) æ—¶è§¦å‘
on:
  watch:
    types: [started]
  fork:

# 2. æ‰§è¡Œä»»åŠ¡
jobs:
  notify:
    runs-on: ubuntu-latest # è¿è¡Œç¯å¢ƒ
    steps:
      - name: Send Notification
        # å¼•å…¥æˆ‘ä»¬åœ¨ Settings é‡Œé…ç½®çš„ Secret ä»¥åŠ GitHub å†…ç½®çš„ç¯å¢ƒå˜é‡
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
          EVENT_NAME: ${{ github.event_name }}
          ACTOR: ${{ github.actor }}          # è§¦å‘åŠ¨ä½œçš„äºº (è° fork/star çš„)
          REPO: ${{ github.repository }}      # å½“å‰ä»“åº“åç§°
          REPO_URL: ${{ github.event.repository.html_url }} # ä»“åº“é“¾æ¥
        run: |
          # 3. åˆ¤æ–­å½“å‰è§¦å‘çš„æ˜¯ Star è¿˜æ˜¯ Fork
          ACTION_TEXT="æ“ä½œ"
          ACTION_TITLE=""
          if [ "$EVENT_NAME" == "watch" ]; then
            ACTION_TEXT="ğŸŒŸ åˆšåˆš Star äº†"
            ACTION_TITLE="ä»“åº“ã€$REPOã€‘æ”¶åˆ° star äº†"
          elif [ "$EVENT_NAME" == "fork" ]; then
            ACTION_TEXT="ğŸ´ åˆšåˆš Fork äº†"
            ACTION_TITLE="ä»“åº“ã€$REPOã€‘æ”¶åˆ° fork äº†"
          fi

          # 4. æ‹¼æ¥è¦å‘é€çš„æ¶ˆæ¯æ–‡æœ¬
          MESSAGE="å¤ªæ£’äº†ï¼ç”¨æˆ· [$ACTOR] $ACTION_TEXT ä½ çš„é¡¹ç›®: $REPOã€‚"

          # 5. å¯¹ title å’Œ message è¿›è¡Œ URL ç¼–ç ï¼Œé¿å…ä¸­æ–‡/emoji/ç©ºæ ¼å¯¼è‡´è¯·æ±‚å¤±è´¥
          ENCODED_TITLE=$(python3 -c "import urllib.parse; print(urllib.parse.quote('''$ACTION_TITLE'''))")
          ENCODED_MESSAGE=$(python3 -c "import urllib.parse; print(urllib.parse.quote('''$MESSAGE'''))")

          # 6. å‘é€é€šçŸ¥ï¼ˆBark é£æ ¼çš„ GET è¯·æ±‚: /key/title/bodyï¼‰
          # æ³¨æ„ï¼šä¸åŒçš„æ¨é€æœåŠ¡æ ¼å¼å¯èƒ½ä¸åŒï¼Œè¯·æ ¹æ®ä½ çš„æœåŠ¡å•†æ–‡æ¡£ä¿®æ”¹
          curl -s -o /dev/null -w "%{http_code}" -X GET "$WEBHOOK_URL/$ENCODED_TITLE/$ENCODED_MESSAGE"
